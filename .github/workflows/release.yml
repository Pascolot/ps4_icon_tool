name: Build & Release APK

on:
    push:
        tags:
            - "v*.*.*" # Triggers on version tags like v1.0.0, v1.2.3
    workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
    build:
        name: Build Signed APK
        runs-on: ubuntu-latest

        steps:
            # 1. Checkout the repository
            - name: Checkout code
              uses: actions/checkout@v4

            # 2. Set up Java 17 (matches your build.gradle.kts jvmToolchain)
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: gradle

            # 3. Grant execute permission to Gradle wrapper
            - name: Grant Gradle execute permission
              run: chmod +x gradlew

            # 4. Recreate the exact folder path your build.gradle.kts expects
            #    and decode the keystore into it
            - name: Decode keystore
              run: |
                  mkdir -p "D:/ps4games/PKG/ilaina/apk-ps3-ps4"
                  echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode \
                    > "D:/ps4games/PKG/ilaina/apk-ps3-ps4/kizeokey.jks"

            # 5. Build the signed release APK
            #    No extra env vars needed â€” gradle reads directly from build.gradle.kts
            - name: Build Release APK
              run: ./gradlew assembleRelease

            # 6. Rename the APK with the version tag
            - name: Rename APK
              run: |
                  VERSION=${GITHUB_REF_NAME:-manual}
                  mv app/build/outputs/apk/release/app-release.apk \
                     app/build/outputs/apk/release/PS4IconTool-${VERSION}.apk

            # 7. Upload APK as a build artifact (visible in Actions tab)
            - name: Upload APK artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PS4IconTool-APK
                  path: app/build/outputs/apk/release/PS4IconTool-*.apk
                  retention-days: 7

            # 8. Create a GitHub Release and attach the APK (only on tag pushes)
            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  name: PS4 Icon Tool ${{ github.ref_name }}
                  tag_name: ${{ github.ref_name }}
                  body: |
                      ## PS4 Icon Tool ${{ github.ref_name }}

                      ### Installation
                      1. Download the APK below.
                      2. Enable **Install from unknown sources** on your Android device.
                      3. Install the APK.

                      ### Requirements
                      - Android 7.0+
                      - PS4 with GoldHEN
                      - FTP server active on the PS4 (port 2121)
                  files: app/build/outputs/apk/release/PS4IconTool-*.apk
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.PS4_ICON }}
