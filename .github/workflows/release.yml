name: Build & Release APK by Sômôlô Games

on:
    push:
        tags:
            - "v*.*.*" # Triggers on version tags like v1.0.0, v1.2.3
    workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
    build:
        name: Build Signed APK
        runs-on: ubuntu-latest

        steps:
            # 1. Checkout the repository
            - name: Checkout code
              uses: actions/checkout@v4

            # 2. Set up Java 17 (matches your build.gradle.kts jvmToolchain)
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: gradle

            # 3. Grant execute permission to Gradle wrapper
            - name: Grant Gradle execute permission
              run: chmod +x gradlew

            # 4. Decode the keystore and place it in the app/ folder
            #    tr -d removes any accidental newlines/spaces that corrupt the file
            - name: Decode keystore
              run: |
                  echo "${{ secrets.KEYSTORE_BASE64 }}" \
                    | tr -d '\n\r ' \
                    | base64 --decode > ${{ github.workspace }}/app/kizeokey.jks

            # 5. Verify the keystore decoded correctly before wasting time on a full build
            - name: Verify keystore
              run: |
                  keytool -list \
                    -keystore ${{ github.workspace }}/app/kizeokey.jks \
                    -storepass mixiaomi16 \
                    -alias hfw

            # 6. Build the signed release APK
            - name: Build Release APK
              run: ./gradlew assembleRelease

            # 7. Rename the APK with the version tag (or "manual" if triggered manually)
            - name: Rename APK
              run: |
                  VERSION=${GITHUB_REF_NAME:-manual}
                  mv app/build/outputs/apk/release/app-release.apk \
                     app/build/outputs/apk/release/PS4IconTool-${VERSION}.apk

            # 8. Upload APK as a build artifact (visible in Actions tab)
            - name: Upload APK artifact
              uses: actions/upload-artifact@v4
              with:
                  name: PS4IconTool-APK
                  path: app/build/outputs/apk/release/PS4IconTool-*.apk
                  retention-days: 7

            # 9. Create a GitHub Release and attach the APK
            #    Runs on tag pushes AND manual triggers
            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
              uses: softprops/action-gh-release@v2
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  name: PS4 Icon Tool ${{ github.ref_name }}
                  tag_name: ${{ github.ref_name }}
                  body: |
                      ## PS4 Icon Tool ${{ github.ref_name }}

                      ### Installation
                      1. Download the APK below.
                      2. Enable **Install from unknown sources** on your Android device.
                      3. Install the APK.

                      ### Requirements
                      - Android 7.0+
                      - PS4 with GoldHEN
                      - FTP server active on the PS4 (port 2121)
                  files: app/build/outputs/apk/release/PS4IconTool-*.apk
                  draft: false
                  prerelease: false
